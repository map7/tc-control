#!/usr/bin/env ruby
#
# Put clients in the clients.json file.
require 'rubygems'
require 'json'

path =  File.expand_path(File.dirname(__FILE__))
file = File.read("#{path}/clients.json")
hash = JSON.parse(file)

def up?(ip)
  result = `ping -c 1 #{ip}`
  if $?.exitstatus == 0
    true
  else
    false    
  end
end

case ARGV[0]
when "shutdown"
  hash["clients"].each {|client|
    puts "Shutdown #{client['name']}..."
    `ssh root@#{client['ip']} 'shutdown -P now'` if up?(client['ip'])
  }
when "startup"
  hash["clients"].each {|client|
    puts "Startup #{client['name']}..."
    `wakeonlan #{client['mac']}`
  }
when "status"
  puts "Check status of each client"
  hash["clients"].each {|client|
    status = up?(client['ip']) ? "up" : "down"
    puts "#{client['name']} is #{status}"
  }
else
  puts "Usage: ./tc-control command
  \nCommands
  startup\tStart thin clients in clients.json
  shutdown\tShutdown clients in clients.json
  status\tCheck if clients are up or down."
end

